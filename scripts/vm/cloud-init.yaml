#cloud-config
# Simple Agent Manager - VM Cloud-Init Template
# This is a reference template. The actual cloud-init is generated by HetznerProvider.

package_update: true
packages:
  - docker.io
  - docker-compose
  - jq
  - curl
  - git

write_files:
  - path: /etc/workspace/config
    permissions: '0600'
    content: |
      WORKSPACE_ID=${WORKSPACE_ID}
      REPO_URL=${REPO_URL}
      BASE_DOMAIN=${BASE_DOMAIN}
      API_URL=${API_URL}
      API_TOKEN=${API_TOKEN}

  - path: /usr/local/bin/idle-check.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Idle detection script - checks every 5 minutes via cron
      IDLE_FILE="/var/run/idle-check.state"
      IDLE_THRESHOLD=30  # minutes
      CHECK_INTERVAL=5   # minutes (cron frequency)

      source /etc/workspace/config

      is_active() {
        # 1. Recent file changes in workspace
        [ -n "$(find /workspace -type f -mmin -$CHECK_INTERVAL 2>/dev/null | head -1)" ] && return 0

        # 2. Active Claude/Node processes (check inside devcontainer)
        docker exec $(docker ps -q --filter "label=devcontainer.local_folder=/workspace" | head -1) pgrep -f "claude|node" >/dev/null 2>&1 && return 0

        # 3. Active VM agent WebSocket connections (port 8080)
        [ "$(ss -tnp 2>/dev/null | grep -c ':8080.*ESTAB')" -gt 0 ] && return 0

        # 4. SSH sessions
        [ "$(who | wc -l)" -gt 0 ] && return 0

        return 1
      }

      if is_active; then
        # Reset idle counter
        echo "0" > "$IDLE_FILE"
        echo "$(date): Active" >> /var/log/idle-check.log
      else
        # Increment idle counter
        IDLE_COUNT=$(cat "$IDLE_FILE" 2>/dev/null || echo "0")
        IDLE_COUNT=$((IDLE_COUNT + CHECK_INTERVAL))
        echo "$IDLE_COUNT" > "$IDLE_FILE"

        echo "$(date): Idle for $IDLE_COUNT minutes" >> /var/log/idle-check.log

        if [ "$IDLE_COUNT" -ge "$IDLE_THRESHOLD" ]; then
          echo "$(date): Threshold reached, initiating shutdown" >> /var/log/idle-check.log

          # Notify control plane for DNS cleanup
          curl -sX POST "$API_URL/vms/$WORKSPACE_ID/cleanup" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"reason": "idle_timeout"}'

          # Self-destruct via Hetzner API
          SERVER_ID=$(curl -s http://169.254.169.254/hetzner/v1/metadata/instance-id)
          curl -X DELETE "https://api.hetzner.cloud/v1/servers/$SERVER_ID" \
            -H "Authorization: Bearer $HETZNER_TOKEN"
        fi
      fi

runcmd:
  # Enable Docker
  - systemctl enable docker
  - systemctl start docker

  # Add user to docker group
  - usermod -aG docker ubuntu

  # Install Node.js 22
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install devcontainer CLI
  - npm install -g @devcontainers/cli

  # Clone repository
  - git clone ${REPO_URL} /workspace || mkdir -p /workspace

  # Setup devcontainer if doesn't exist
  - |
    if [ ! -f /workspace/.devcontainer/devcontainer.json ]; then
      mkdir -p /workspace/.devcontainer
      cat > /workspace/.devcontainer/devcontainer.json << 'DEVEOF'
      {
        "name": "Claude Code Workspace",
        "image": "mcr.microsoft.com/devcontainers/base:ubuntu-22.04",
        "features": {
          "ghcr.io/devcontainers/features/git:1": {},
          "ghcr.io/devcontainers/features/github-cli:1": {},
          "ghcr.io/devcontainers/features/node:1": { "version": "22" },
          "ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {}
        },
        "postCreateCommand": "claude --version",
        "remoteUser": "vscode"
      }
      DEVEOF
    fi

  # Start devcontainer with ACP agent adapters injected as additional features.
  # Node.js feature ensures npm is available; npm-package feature installs claude-code-acp globally.
  - cd /workspace && devcontainer up --workspace-folder . --additional-features '{"ghcr.io/devcontainers/features/node:1":{"version":"22"},"ghcr.io/devcontainers-community/npm-features/npm-package:1":{"package":"@zed-industries/claude-code-acp"}}'

  # Setup idle check cron (every 5 minutes)
  - echo "*/5 * * * * root /usr/local/bin/idle-check.sh" > /etc/cron.d/idle-check
