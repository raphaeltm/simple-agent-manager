name = "workspaces-api"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]
port = 8787

[vars]
BASE_DOMAIN = "workspaces.example.com"
VERSION = "0.1.0"
MAX_NODES_PER_USER = "10"
MAX_WORKSPACES_PER_USER = "10"
MAX_WORKSPACES_PER_NODE = "10"
MAX_AGENT_SESSIONS_PER_WORKSPACE = "10"
NODE_HEARTBEAT_STALE_SECONDS = "180"
MAX_PROJECTS_PER_USER = "50"
MAX_SESSIONS_PER_PROJECT = "1000"
MAX_MESSAGES_PER_SESSION = "10000"
MESSAGE_SIZE_THRESHOLD = "102400"
ACTIVITY_RETENTION_DAYS = "90"
SESSION_IDLE_TIMEOUT_MINUTES = "60"
DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000"

# D1 Database
[[d1_databases]]
binding = "DATABASE"
database_name = "workspaces-dev"
database_id = "your-d1-database-id"
migrations_dir = "src/db/migrations"

# D1 Observability Database (error storage, isolated from main DB — spec 023)
[[d1_databases]]
binding = "OBSERVABILITY_DATABASE"
database_name = "observability-dev"
database_id = "your-observability-d1-id"
migrations_dir = "src/db/migrations/observability"

# KV for sessions
[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

# R2 for VM Agent binaries
[[r2_buckets]]
binding = "R2"
bucket_name = "workspaces-dev-assets"


# Durable Objects for per-project data (chat sessions, activity events, task status events)
[[durable_objects.bindings]]
name = "PROJECT_DATA"
class_name = "ProjectData"

# Durable Objects for per-node warm pool lifecycle (alarm-based idle timeout)
[[durable_objects.bindings]]
name = "NODE_LIFECYCLE"
class_name = "NodeLifecycle"

# Durable Object for admin real-time log streaming (singleton — spec 023)
[[durable_objects.bindings]]
name = "ADMIN_LOGS"
class_name = "AdminLogs"

# Durable Object for alarm-driven task orchestration (TDF-2 — one DO per task)
[[durable_objects.bindings]]
name = "TASK_RUNNER"
class_name = "TaskRunner"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["ProjectData"]

[[migrations]]
tag = "v2"
new_classes = ["NodeLifecycle"]

[[migrations]]
tag = "v3"
new_classes = ["AdminLogs"]

[[migrations]]
tag = "v4"
new_classes = ["TaskRunner"]

# Workers AI for speech-to-text transcription
[ai]
binding = "AI"

# Environment-specific configuration
[env.staging]
name = "sam-api-staging"
vars = { BASE_DOMAIN = "staging.workspaces.example.com", VERSION = "0.1.0", MAX_NODES_PER_USER = "10", MAX_WORKSPACES_PER_USER = "10", MAX_WORKSPACES_PER_NODE = "10", MAX_AGENT_SESSIONS_PER_WORKSPACE = "10", NODE_HEARTBEAT_STALE_SECONDS = "180", MAX_PROJECTS_PER_USER = "50", MAX_SESSIONS_PER_PROJECT = "1000", MAX_MESSAGES_PER_SESSION = "10000", MESSAGE_SIZE_THRESHOLD = "102400", ACTIVITY_RETENTION_DAYS = "90", SESSION_IDLE_TIMEOUT_MINUTES = "60", DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000" }

[[env.staging.d1_databases]]
binding = "DATABASE"
database_name = "workspaces-staging"
database_id = "your-staging-d1-id"
migrations_dir = "src/db/migrations"

[[env.staging.d1_databases]]
binding = "OBSERVABILITY_DATABASE"
database_name = "observability-staging"
database_id = "your-staging-observability-d1-id"
migrations_dir = "src/db/migrations/observability"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "your-staging-kv-id"

[[env.staging.r2_buckets]]
binding = "R2"
bucket_name = "workspaces-staging-assets"

[env.staging.ai]
binding = "AI"

# Tail Worker for real-time log streaming (spec 023 — US4)
# NOTE: tail_consumers MUST NOT be in default config — it breaks Vitest (Cloudflare issue #9343)
[[env.staging.tail_consumers]]
service = "sam-tail-worker-staging"

[env.production]
name = "sam-api-prod"
vars = { BASE_DOMAIN = "workspaces.example.com", VERSION = "0.1.0", MAX_NODES_PER_USER = "10", MAX_WORKSPACES_PER_USER = "10", MAX_WORKSPACES_PER_NODE = "10", MAX_AGENT_SESSIONS_PER_WORKSPACE = "10", NODE_HEARTBEAT_STALE_SECONDS = "180", MAX_PROJECTS_PER_USER = "50", MAX_SESSIONS_PER_PROJECT = "1000", MAX_MESSAGES_PER_SESSION = "10000", MESSAGE_SIZE_THRESHOLD = "102400", ACTIVITY_RETENTION_DAYS = "90", SESSION_IDLE_TIMEOUT_MINUTES = "60", DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000" }

[env.production.observability]
enabled = true

  [env.production.observability.logs]
  invocation_logs = true
  head_sampling_rate = 1

[[env.production.d1_databases]]
binding = "DATABASE"
database_name = "workspaces"
database_id = "your-production-d1-id"
migrations_dir = "src/db/migrations"

[[env.production.d1_databases]]
binding = "OBSERVABILITY_DATABASE"
database_name = "observability"
database_id = "your-production-observability-d1-id"
migrations_dir = "src/db/migrations/observability"

[[env.production.kv_namespaces]]
binding = "KV"
id = "your-production-kv-id"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "workspaces-assets"

[env.production.ai]
binding = "AI"

# Tail Worker for real-time log streaming (spec 023 — US4)
[[env.production.tail_consumers]]
service = "sam-tail-worker-prod"

# Cron trigger for provisioning timeout checks + warm node cleanup (every 5 minutes)
[triggers]
crons = ["*/5 * * * *"]

# Secrets (set via wrangler secret put):
# - GITHUB_CLIENT_ID
# - GITHUB_CLIENT_SECRET
# - GITHUB_APP_ID
# - GITHUB_APP_PRIVATE_KEY
# - CF_API_TOKEN
# - CF_ZONE_ID
# - CF_ACCOUNT_ID (required for admin observability log viewer)
# - JWT_PRIVATE_KEY
# - JWT_PUBLIC_KEY
# - ENCRYPTION_KEY
