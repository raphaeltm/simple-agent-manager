name = "workspaces-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
port = 8787

[vars]
BASE_DOMAIN = "workspaces.example.com"
VERSION = "0.1.0"
MAX_NODES_PER_USER = "10"
MAX_WORKSPACES_PER_USER = "10"
MAX_WORKSPACES_PER_NODE = "10"
MAX_AGENT_SESSIONS_PER_WORKSPACE = "10"
NODE_HEARTBEAT_STALE_SECONDS = "180"
MAX_PROJECTS_PER_USER = "50"
MAX_SESSIONS_PER_PROJECT = "1000"
MAX_MESSAGES_PER_SESSION = "10000"
MESSAGE_SIZE_THRESHOLD = "102400"
ACTIVITY_RETENTION_DAYS = "90"
SESSION_IDLE_TIMEOUT_MINUTES = "60"
DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000"

# D1 Database
[[d1_databases]]
binding = "DATABASE"
database_name = "workspaces-dev"
database_id = "your-d1-database-id"
migrations_dir = "src/db/migrations"

# KV for sessions
[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

# R2 for VM Agent binaries
[[r2_buckets]]
binding = "R2"
bucket_name = "workspaces-dev-assets"


# Durable Objects for per-project data (chat sessions, activity events, task status events)
[[durable_objects.bindings]]
name = "PROJECT_DATA"
class_name = "ProjectData"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["ProjectData"]

# Workers AI for speech-to-text transcription
[ai]
binding = "AI"

# Environment-specific configuration
[env.staging]
name = "sam-api-staging"
vars = { BASE_DOMAIN = "staging.workspaces.example.com", VERSION = "0.1.0", MAX_NODES_PER_USER = "10", MAX_WORKSPACES_PER_USER = "10", MAX_WORKSPACES_PER_NODE = "10", MAX_AGENT_SESSIONS_PER_WORKSPACE = "10", NODE_HEARTBEAT_STALE_SECONDS = "180", MAX_PROJECTS_PER_USER = "50", MAX_SESSIONS_PER_PROJECT = "1000", MAX_MESSAGES_PER_SESSION = "10000", MESSAGE_SIZE_THRESHOLD = "102400", ACTIVITY_RETENTION_DAYS = "90", SESSION_IDLE_TIMEOUT_MINUTES = "60", DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000" }

[[env.staging.d1_databases]]
binding = "DATABASE"
database_name = "workspaces-staging"
database_id = "your-staging-d1-id"
migrations_dir = "src/db/migrations"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "your-staging-kv-id"

[[env.staging.r2_buckets]]
binding = "R2"
bucket_name = "workspaces-staging-assets"

[env.staging.ai]
binding = "AI"

[env.production]
name = "sam-api-prod"
vars = { BASE_DOMAIN = "workspaces.example.com", VERSION = "0.1.0", MAX_NODES_PER_USER = "10", MAX_WORKSPACES_PER_USER = "10", MAX_WORKSPACES_PER_NODE = "10", MAX_AGENT_SESSIONS_PER_WORKSPACE = "10", NODE_HEARTBEAT_STALE_SECONDS = "180", MAX_PROJECTS_PER_USER = "50", MAX_SESSIONS_PER_PROJECT = "1000", MAX_MESSAGES_PER_SESSION = "10000", MESSAGE_SIZE_THRESHOLD = "102400", ACTIVITY_RETENTION_DAYS = "90", SESSION_IDLE_TIMEOUT_MINUTES = "60", DO_SUMMARY_SYNC_DEBOUNCE_MS = "5000" }

[env.production.observability]
enabled = true

  [env.production.observability.logs]
  invocation_logs = true
  head_sampling_rate = 1

[[env.production.d1_databases]]
binding = "DATABASE"
database_name = "workspaces"
database_id = "your-production-d1-id"
migrations_dir = "src/db/migrations"

[[env.production.kv_namespaces]]
binding = "KV"
id = "your-production-kv-id"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "workspaces-assets"

[env.production.ai]
binding = "AI"

# Cron trigger for provisioning timeout checks (every 5 minutes)
[triggers]
crons = ["*/5 * * * *"]

# Secrets (set via wrangler secret put):
# - GITHUB_CLIENT_ID
# - GITHUB_CLIENT_SECRET
# - GITHUB_APP_ID
# - GITHUB_APP_PRIVATE_KEY
# - CF_API_TOKEN
# - CF_ZONE_ID
# - JWT_PRIVATE_KEY
# - JWT_PUBLIC_KEY
# - ENCRYPTION_KEY
