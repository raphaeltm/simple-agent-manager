# Implementation Plan: Project-First Architecture

**Branch**: `018-project-first-architecture` | **Date**: 2026-02-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/018-project-first-architecture/spec.md`

## Summary

Transform SAM from a workspace-centric model to a project-first architecture where projects (linked to GitHub repos by stable numeric ID) are the primary organizational unit. Workspaces become child entities of projects. Each project gets a Durable Object with embedded SQLite for high-throughput isolated data (chat sessions, task events, activity logs). The central D1 database remains for platform metadata and cross-project dashboard queries. This enables chat history persistence beyond workspace lifecycle, project-scoped navigation, and real-time data isolation per project.

## Technical Context

**Language/Version**: TypeScript 5.x (Worker/Web), Go 1.22+ (VM Agent)
**Primary Dependencies**: Hono (API framework), Drizzle ORM (D1), React + Vite (Web), Cloudflare Workers SDK (Durable Objects)
**Storage**: Cloudflare D1 (platform metadata) + Durable Objects with SQLite (per-project high-throughput data) + KV (ephemeral tokens) + R2 (agent binaries)
**Testing**: Vitest + Miniflare (Worker integration tests), Playwright (E2E)
**Target Platform**: Cloudflare Workers (serverless edge), Hetzner Cloud VMs
**Project Type**: Web application (monorepo: API Worker + Web UI + shared packages)
**Performance Goals**: <100ms added latency for chat message persistence (FR-033/SC-005), <3s session history load (SC-004), zero cross-project interference under concurrent load (SC-006)
**Constraints**: D1 single-writer bottleneck (~1,000 writes/sec), DO 10GB per-object storage limit, Worker 128MB memory limit, 30s CPU time limit per request
**Scale/Scope**: Single user initially, designed for multi-user scaling. ~50 projects, ~100 sessions/project, ~50 messages/session. Cost at this scale: $5/month (Workers Paid minimum).

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Open Source** | PASS | All DO/D1 code remains in open source packages |
| **II. Infrastructure Stability** | PASS | TDD required for DO class, migration logic, message persistence pipeline. >90% coverage for critical paths. |
| **III. Documentation Excellence** | PASS | Plan, research, data-model, contracts, quickstart all generated. ADR for hybrid storage decision. |
| **IV. Approachable Code** | PASS | DO class follows single-responsibility (one per project). Functions <50 lines. |
| **V. Transparent Roadmap** | PASS | Spec 018 tracked in specs/, tasks generated via speckit |
| **VI. Automated Quality Gates** | PASS | CI runs lint/typecheck/test on all changes including DO code |
| **VII. Inclusive Contribution** | PASS | No barriers introduced |
| **VIII. AI-Friendly Repository** | PASS | DO patterns documented, CLAUDE.md updated with DO context |
| **IX. Clean Code Architecture** | PASS | DO class in `apps/api/src/durable-objects/`, shared types in `packages/shared/` |
| **X. Simplicity & Clarity** | PASS | Hybrid D1+DO is minimal complexity for the requirements. No premature abstractions. |
| **XI. No Hardcoded Values** | PASS | All limits configurable: `MAX_SESSIONS_PER_PROJECT`, `MAX_MESSAGES_PER_SESSION`, `MESSAGE_SIZE_THRESHOLD`, `ACTIVITY_RETENTION_DAYS`, `DO_INIT_TIMEOUT_MS`. URLs derived from `BASE_DOMAIN`. |
| **XII. Zero-to-Production Deployability** | PASS | DO namespace in Pulumi stack. D1 migrations replayable from zero. Self-hosting docs updated for new DO binding + env vars. ADR for hybrid D1+DO storage decision. Teardown cleans up DO namespace. |

**Gate Result: PASS** — No violations. Proceeding to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/018-project-first-architecture/
├── plan.md              # This file
├── research.md          # Phase 0: Technology decisions and rationale
├── data-model.md        # Phase 1: Entity schemas, state machines, storage allocation
├── quickstart.md        # Phase 1: Developer onboarding for this feature
├── contracts/           # Phase 1: API contract definitions
│   └── api.yaml         # OpenAPI spec for new/modified endpoints
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
apps/api/
├── src/
│   ├── durable-objects/           # NEW: Durable Object classes
│   │   ├── project-data.ts        # Per-project DO (chat sessions, messages, events, tasks)
│   │   └── migrations.ts          # DO SQLite migration runner + migration definitions
│   ├── routes/
│   │   ├── projects.ts            # MODIFIED: Add github_repo_id, stable identity, project-first nav
│   │   ├── workspaces.ts          # MODIFIED: Require project_id, pre-fill from project context
│   │   ├── chat.ts                # NEW: Chat session/message endpoints (proxy to DO)
│   │   └── activity.ts            # NEW: Activity feed endpoints (proxy to DO)
│   ├── services/
│   │   ├── project-data.ts        # NEW: Service layer for DO interaction (stub management)
│   │   └── chat-persistence.ts    # NEW: Message persistence pipeline (VM -> API -> DO)
│   ├── db/
│   │   ├── schema.ts              # MODIFIED: Add github_repo_id to projects, make workspace.projectId required
│   │   └── migrations/            # MODIFIED: D1 migration for schema changes
│   └── index.ts                   # MODIFIED: Export DO class, register new routes
├── wrangler.toml                  # MODIFIED: Add DO bindings + SQLite migration tags
└── tests/
    ├── unit/
    │   ├── project-data-do.test.ts     # DO class unit tests
    │   └── chat-persistence.test.ts    # Persistence pipeline tests
    └── integration/
        └── project-data.test.ts        # DO integration tests with Miniflare

apps/web/
├── src/
│   ├── pages/
│   │   ├── Dashboard.tsx          # MODIFIED: Project-first landing page
│   │   ├── Project.tsx            # MODIFIED: Add chat sessions tab, activity feed
│   │   └── ChatSession.tsx        # NEW: Session viewer with message history
│   ├── components/
│   │   ├── ChatSessionList.tsx    # NEW: Session list for project detail
│   │   ├── ActivityFeed.tsx       # NEW: Activity event timeline
│   │   └── ProjectSummaryCard.tsx # NEW: Dashboard project card with activity summary
│   └── hooks/
│       └── useProjectData.ts      # NEW: Hooks for DO-backed data (sessions, events)

packages/shared/
└── src/
    └── types.ts                   # MODIFIED: Add ChatSession, ChatMessage, ActivityEvent types
```

**Structure Decision**: Existing monorepo structure (apps/api + apps/web + packages/shared). New DO class lives in `apps/api/src/durable-objects/` as a peer to `routes/` and `services/`. This follows the Cloudflare pattern where the DO class is exported from the same Worker entry point. No new packages needed — the DO is tightly coupled to the API Worker's bindings and deployment.

## Complexity Tracking

No constitution violations requiring justification. The hybrid D1+DO architecture is the minimum complexity needed to satisfy the chat persistence and data isolation requirements.
