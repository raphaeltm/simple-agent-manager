# Data Model: Multi-Workspace Nodes

**Feature**: `/workspaces/hierarchy-planning/specs/014-multi-workspace-nodes/spec.md`  
**Research**: `/workspaces/hierarchy-planning/specs/014-multi-workspace-nodes/research.md`  
**Created**: February 10, 2026

This document defines the domain entities, relationships, lifecycle states, and validation rules needed to support:
- User -> Nodes -> Workspaces -> Agent Sessions
- Multiple Workspaces per single Node
- Single-user Nodes (no sharing)
- Workspace stop/restart semantics that preserve files and terminate sessions
- Per-Workspace port/network isolation (no port conflicts)

## Entities

### Node

Represents a single user-owned compute host (a VM) that runs exactly one Node Agent and can host multiple Workspaces.

Fields (conceptual):
- `id`: globally unique identifier (generated by Control Plane)
- `userId`: owner user identifier (single-user ownership)
- `provider`: cloud provider identifier (current provider is Hetzner)
- `vmSize`, `vmLocation`: provisioning parameters
- `status`: lifecycle status (see Node State Machine)
- `providerInstanceId`: provider-specific identifier (e.g., server ID)
- `ipAddress`: public IP address when running
- `lastHeartbeatAt`: last successful Node Agent check-in timestamp (used for health freshness)
- `healthStatus`: derived health indicator (`healthy` | `stale` | `unhealthy`) computed from heartbeat freshness and node lifecycle status
- `heartbeatStaleAfterSeconds`: effective staleness threshold from configuration (for example `NODE_HEARTBEAT_STALE_SECONDS`)
- `createdAt`, `updatedAt`
- `errorMessage`: last failure reason (if in `error`)

### Workspace

Represents an isolated dev environment hosted within a Node (typically a devcontainer instance).

Fields (conceptual):
- `id`: globally unique identifier (generated by Control Plane; used in `ws-{id}` subdomains)
- `nodeId`: parent Node identifier
- `userId`: owner user identifier (same as parent Node owner)
- `displayName`: user-visible name (auto-adjusted to be unique within a Node)
- `normalizedDisplayName`: canonicalized name used for case-insensitive uniqueness checks within a Node
- `repository`: source project/repository reference
- `branch`: source branch reference
- `status`: lifecycle status (see Workspace State Machine)
- `createdAt`, `updatedAt`
- `lastActivityAt`: last user activity timestamp (optional but useful for UX)
- `errorMessage`: last failure reason (if in `error`)

### Agent Session

Represents a single interactive agent run within a Workspace. Sessions are ephemeral and do not survive Workspace stop/restart.

Fields (conceptual):
- `id`: globally unique identifier
- `workspaceId`: parent Workspace identifier
- `userId`: owner user identifier
- `status`: `running` | `stopped` | `error`
- `createdAt`, `updatedAt`
- `stoppedAt` (optional)
- `errorMessage` (optional)

### Node Event

Represents a structured runtime/provisioning event emitted by the Node Agent for a Node.

Fields (conceptual):
- `id`: globally unique identifier
- `nodeId`: parent Node identifier
- `level`: `info` | `warn` | `error`
- `type`: machine-readable event type (for example `provision.start`, `workspace.create.failed`)
- `message`: user-readable summary
- `detail`: optional structured detail payload
- `createdAt`

### Workspace Event

Represents a structured runtime/provisioning event emitted by the Node Agent for a specific Workspace.

Fields (conceptual):
- `id`: globally unique identifier
- `workspaceId`: parent Workspace identifier
- `nodeId`: parent Node identifier
- `level`: `info` | `warn` | `error`
- `type`: machine-readable event type
- `message`: user-readable summary
- `detail`: optional structured detail payload
- `createdAt`

## Relationships

- A User owns many Nodes.
- A Node belongs to exactly one User.
- A Node hosts many Workspaces.
- A Workspace belongs to exactly one Node and one User.
- A Workspace has many Agent Sessions.
- An Agent Session belongs to exactly one Workspace and one User.

## Identity and Uniqueness Rules

- `Node.id` is globally unique.
- `Workspace.id` is globally unique and is the identifier used for `ws-{workspaceId}.${BASE_DOMAIN}` routing.
- `Workspace.displayName` is unique within a Node.
- If a user requests a duplicate `Workspace.displayName` within the same Node (create or rename), the system automatically adjusts it to a unique name and returns the final name to the user.
- Database layer MUST enforce uniqueness with a composite unique index on (`nodeId`, `normalizedDisplayName`) to prevent race-condition duplicates.

## Lifecycle / State Transitions

### Node State Machine

States:
- `pending`: record exists but provisioning not started
- `creating`: VM provisioning in progress
- `running`: VM is up and Node Agent is ready
- `stopping`: Node shutdown/deletion in progress
- `stopped`: Node is not running and cannot host Workspaces until restarted (if restart is supported)
- `error`: provisioning or lifecycle operation failed

Transitions (examples):
- `pending` -> `creating` -> `running`
- `running` -> `stopping` -> `stopped`
- `creating` -> `error`
- `running` -> `error` (health failure)

### Workspace State Machine

States:
- `pending`: record exists but creation not started on the Node
- `creating`: environment/devcontainer creation in progress
- `running`: Workspace is ready for terminal + agent use
- `stopping`: stop requested; processes are terminating
- `stopped`: Workspace files/config are preserved but processes are not running
- `error`: creation or lifecycle operation failed

Transitions (examples):
- `pending` -> `creating` -> `running`
- `running` -> `stopping` -> `stopped`
- `stopped` -> `creating` -> `running` (restart)
- any -> `error`

### Agent Session State Machine

States:
- `running`
- `stopped`
- `error`

Rules:
- Stopping or restarting a Workspace transitions all its Agent Sessions to `stopped` and makes them non-attachable.
- Agent Sessions do not survive Workspace stop/restart.
- No automatic idle timeout transition is performed in this feature.
- At most one interactive attachment is active per session by default; explicit takeover is required to replace an active attachment.

## Validation Rules

- Ownership:
- A user can only view or operate on Nodes, Workspaces, and Agent Sessions where `userId` matches the authenticated user.
- A Workspace's `nodeId` must refer to an existing Node owned by the same user.

- Capacity/limits (all configurable via environment with defaults):
- Maximum Nodes per user
- Maximum Workspaces per user
- Maximum Workspaces per Node
- Maximum Agent Sessions per Workspace
- Node heartbeat stale threshold (`NODE_HEARTBEAT_STALE_SECONDS`)

- Port/network isolation:
- Multiple Workspaces on the same Node must be able to run services on the same ports concurrently without conflicts.
- Any user-visible "service URLs" must be scoped to a Workspace so that port collisions do not leak across Workspaces.

- Trusted routing context:
- Proxied Workspace requests include both `nodeId` and `workspaceId` as trusted routing context from the Control Plane.
- Node Agent validates routed `workspaceId` against user auth claims before serving terminal/agent traffic.
- Client-supplied routing headers are never trusted as authoritative routing inputs.
- Control Plane strips inbound `X-SAM-*` routing headers and injects authoritative values derived from DB state.

- Heartbeat freshness and health state:
- `healthStatus=healthy` when heartbeat age is within configured threshold.
- `healthStatus=stale` when heartbeat age exceeds configured threshold while Node is expected to be running.
- `healthStatus=unhealthy` when Node is in `error` or when stale health has exceeded operator-defined grace/failure handling.

## Migration Notes (From Current Model)

Current behavior is effectively "1 Workspace = 1 VM". This feature introduces a separate Node entity and moves VM lifecycle to Nodes.

Pre-production note:
- This project is not in production. No legacy live-data migration strategy is required for this feature.
- Implementations should still preserve `ws-{workspaceId}` URLs in the new model.
