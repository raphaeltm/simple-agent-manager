# Implementation Plan: Worktree Context Switching

**Branch**: `015-worktree-context` | **Date**: 2026-02-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/015-worktree-context/spec.md`

## Summary

Deep git worktree integration for workspace context switching. Users can create, list, switch, and remove git worktrees within a running workspace. The active worktree scopes the file browser, git viewer, and new terminal/agent chat sessions to the selected branch's directory. Existing terminal and agent sessions retain their original worktree binding. The implementation spans three layers: VM Agent (Go) for worktree CRUD and scoped operations, frontend (React) for selector UI and context propagation, and control plane (API) for agent session metadata persistence.

## Technical Context

**Language/Version**: TypeScript 5.x (API, Web, Shared), Go 1.22+ (VM Agent)
**Primary Dependencies**: Hono (API), React 18 + Vite (Web), gorilla/websocket + creack/pty (VM Agent), @dnd-kit (tab reorder), xterm.js (terminal)
**Storage**: Cloudflare D1 (SQLite) for agent session metadata, localStorage for tab ordering and active worktree, SQLite (VM Agent local) for tab persistence
**Testing**: Vitest + Miniflare (API/Web), Go testing (VM Agent)
**Target Platform**: Cloudflare Workers (API), Cloudflare Pages (Web), Hetzner VM (VM Agent)
**Project Type**: Monorepo (pnpm workspaces + Turborepo)
**Performance Goals**: Worktree switching < 1s (no page reload), worktree creation < 10s wall-clock
**Constraints**: Named Docker volumes mount at `/workspaces` (parent dir — sibling worktree dirs already visible), configurable max worktrees per workspace
**Scale/Scope**: Single user per workspace, up to 10 worktrees per workspace (configurable)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Open Source** | PASS | Feature is core platform functionality, no premium gate |
| **II. Infrastructure Stability** | PASS | Tests required for all new endpoints and components; TDD for critical paths (worktree creation, path validation) |
| **III. Documentation Excellence** | PASS | Spec exists, plan + data model + contracts generated, CLAUDE.md updated on completion |
| **IV. Approachable Code** | PASS | Clean separation: VM Agent endpoints, frontend components, shared types |
| **V. Transparent Roadmap** | PASS | Spec 015 tracks the feature; tasks.md will be generated |
| **VI. Automated Quality Gates** | PASS | CI runs lint, typecheck, test; no bypass needed |
| **VII. Inclusive Contribution** | PASS | Standard contribution flow |
| **VIII. AI-Friendly Repository** | PASS | CLAUDE.md and AGENTS.md updated with new env vars, endpoints, and recent changes |
| **IX. Clean Code Architecture** | PASS | New code follows existing patterns: Go handlers in `internal/server/`, React components in `apps/web/src/components/`, shared types in `packages/shared/` |
| **X. Simplicity & Clarity** | PASS | Leverages existing `docker exec` and `ContainerWorkDir` plumbing; no new abstractions beyond what's needed |
| **XI. No Hardcoded Values** | REQUIRES ATTENTION | Max worktrees per workspace MUST be configurable via `MAX_WORKTREES_PER_WORKSPACE` env var with a `DEFAULT_MAX_WORKTREES_PER_WORKSPACE` constant. Worktree operation timeouts must be configurable. |

**Gate violations requiring justification**: None. Principle XI compliance is achievable by following the established pattern (DEFAULT_* constant + env var override).

## Project Structure

### Documentation (this feature)

```text
specs/015-worktree-context/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
│   └── api.md           # Worktree API contracts
├── checklists/          # Quality checklists
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# VM Agent (Go) — new/modified files
packages/vm-agent/
├── internal/
│   ├── server/
│   │   ├── worktrees.go           # NEW: Worktree CRUD handlers
│   │   ├── worktree_validation.go # NEW: Path validation against git worktree list
│   │   ├── git.go                 # MODIFIED: Accept optional worktree query param
│   │   ├── files.go               # MODIFIED: Accept optional worktree query param
│   │   ├── workspace_routing.go   # MODIFIED: Resolve worktree paths
│   │   ├── agent_ws.go            # MODIFIED: Accept worktree param for new sessions
│   │   └── server.go              # MODIFIED: Register new routes, config for limits
│   ├── config/
│   │   └── config.go              # MODIFIED: New env vars for worktree limits/timeouts
│   └── pty/
│       └── manager.go             # MODIFIED: CreateSessionWithWorkDir method
└── tests/
    └── worktrees_test.go          # NEW: Worktree endpoint tests

# Frontend (React) — new/modified files
apps/web/src/
├── components/
│   ├── WorktreeSelector.tsx       # NEW: Header dropdown for worktree switching
│   ├── WorktreeCreateDialog.tsx   # NEW: Modal for creating worktrees
│   ├── FileBrowserPanel.tsx       # MODIFIED: Accept worktree prop
│   ├── GitChangesPanel.tsx        # MODIFIED: Accept worktree prop
│   ├── GitDiffView.tsx            # MODIFIED: Accept worktree prop
│   ├── ChatSession.tsx            # MODIFIED: Pass worktree at creation
│   ├── WorkspaceTabStrip.tsx      # MODIFIED: Display worktree badges
│   └── FileViewerPanel.tsx        # MODIFIED: Accept worktree prop
├── pages/
│   └── Workspace.tsx              # MODIFIED: Add worktree state, selector, propagation
├── hooks/
│   └── useWorktrees.ts            # NEW: Worktree CRUD hook (list, create, remove)
└── lib/
    └── api.ts                     # MODIFIED: Add worktree API client functions

# Shared Types
packages/shared/src/
├── types.ts                       # MODIFIED: Add WorktreeInfo, worktree-related types
└── constants.ts                   # MODIFIED: Add DEFAULT_MAX_WORKTREES_PER_WORKSPACE

# Control Plane API
apps/api/src/
├── db/
│   └── schema.ts                  # MODIFIED: Add worktree_path column to agent_sessions
├── routes/
│   └── workspaces.ts              # MODIFIED: Accept worktree in create-agent-session, return in responses
└── migrations/
    └── NNNN_add_worktree_path.sql # NEW: D1 migration for agent_sessions.worktree_path
```

**Structure Decision**: Follows existing monorepo patterns. New Go handlers in `internal/server/` (worktree-specific files), new React components for selector UI, shared types extended for worktree concepts. No new packages needed.

## Complexity Tracking

> No Constitution Check violations requiring justification.

| Decision | Rationale | Simpler Alternative Rejected Because |
|----------|-----------|--------------------------------------|
| Separate `worktrees.go` handler file | Keeps worktree CRUD isolated from git operations (which are read-only) | Putting in git.go would mix CRUD mutations with read queries |
| `worktree` query param on existing endpoints | Non-breaking change; omitting param preserves existing behavior (primary worktree) | Separate URL paths per worktree would require large routing changes |
| Worktree badge on tabs rather than filtering | Developers run terminals across worktrees simultaneously; filtering hides active work | Filtering would require remembering to switch back |
| URL-driven active worktree (`?worktree=...`) | Deep-linkable, survives reload, consistent with existing URL-state patterns | Component state would be lost on reload |
